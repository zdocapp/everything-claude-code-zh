{
  "sourceFile": "skills/django-tdd/SKILL.md",
  "sourceLanguage": "en-US",
  "entries": [
    {
      "en-US": "---\nname: django-tdd\ndescription: Django testing strategies with pytest-django, TDD methodology, factory_boy, mocking, coverage, and testing Django REST Framework APIs.\n---",
      "zh-Hans": "---\nname: django-tdd\ndescription: Django测试策略，包括pytest-django、TDD方法论、factory_boy、模拟、覆盖率以及测试Django REST Framework API。\n---"
    },
    {
      "en-US": "# Django Testing with TDD",
      "zh-Hans": "# 使用 TDD 进行 Django 测试"
    },
    {
      "en-US": "Test-driven development for Django applications using pytest, factory_boy, and Django REST Framework.",
      "zh-Hans": "使用 pytest、factory\\_boy 和 Django REST Framework 进行 Django 应用程序的测试驱动开发。"
    },
    {
      "en-US": "## When to Activate",
      "zh-Hans": "## 何时激活"
    },
    {
      "en-US": "- Writing new Django applications\n- Implementing Django REST Framework APIs\n- Testing Django models, views, and serializers\n- Setting up testing infrastructure for Django projects",
      "zh-Hans": "* 编写新的 Django 应用程序时\n* 实现 Django REST Framework API 时\n* 测试 Django 模型、视图和序列化器时\n* 为 Django 项目设置测试基础设施时"
    },
    {
      "en-US": "## TDD Workflow for Django",
      "zh-Hans": "## Django 的 TDD 工作流"
    },
    {
      "en-US": "### Red-Green-Refactor Cycle",
      "zh-Hans": "### 红-绿-重构循环"
    },
    {
      "en-US": "```python\n# Step 1: RED - Write failing test\ndef test_user_creation():\n    user = User.objects.create_user(email='test@example.com', password='testpass123')\n    assert user.email == 'test@example.com'\n    assert user.check_password('testpass123')\n    assert not user.is_staff\n\n# Step 2: GREEN - Make test pass\n# Create User model or factory\n\n# Step 3: REFACTOR - Improve while keeping tests green\n```",
      "zh-Hans": "```python\n# Step 1: RED - Write failing test\ndef test_user_creation():\n    user = User.objects.create_user(email='test@example.com', password='testpass123')\n    assert user.email == 'test@example.com'\n    assert user.check_password('testpass123')\n    assert not user.is_staff\n\n# Step 2: GREEN - Make test pass\n# Create User model or factory\n\n# Step 3: REFACTOR - Improve while keeping tests green\n```"
    },
    {
      "en-US": "## Setup",
      "zh-Hans": "## 设置"
    },
    {
      "en-US": "### pytest Configuration",
      "zh-Hans": "### pytest 配置"
    },
    {
      "en-US": "```ini\n# pytest.ini\n[pytest]\nDJANGO_SETTINGS_MODULE = config.settings.test\ntestpaths = tests\npython_files = test_*.py\npython_classes = Test*\npython_functions = test_*\naddopts =\n    --reuse-db\n    --nomigrations\n    --cov=apps\n    --cov-report=html\n    --cov-report=term-missing\n    --strict-markers\nmarkers =\n    slow: marks tests as slow\n    integration: marks tests as integration tests\n```",
      "zh-Hans": "```ini\n# pytest.ini\n[pytest]\nDJANGO_SETTINGS_MODULE = config.settings.test\ntestpaths = tests\npython_files = test_*.py\npython_classes = Test*\npython_functions = test_*\naddopts =\n    --reuse-db\n    --nomigrations\n    --cov=apps\n    --cov-report=html\n    --cov-report=term-missing\n    --strict-markers\nmarkers =\n    slow: marks tests as slow\n    integration: marks tests as integration tests\n```"
    },
    {
      "en-US": "### Test Settings",
      "zh-Hans": "### 测试设置"
    },
    {
      "en-US": "```python\n# config/settings/test.py\nfrom .base import *\n\nDEBUG = True\nDATABASES = {\n    'default': {\n        'ENGINE': 'django.db.backends.sqlite3',\n        'NAME': ':memory:',\n    }\n}\n\n# Disable migrations for speed\nclass DisableMigrations:\n    def __contains__(self, item):\n        return True\n\n    def __getitem__(self, item):\n        return None\n\nMIGRATION_MODULES = DisableMigrations()\n\n# Faster password hashing\nPASSWORD_HASHERS = [\n    'django.contrib.auth.hashers.MD5PasswordHasher',\n]\n\n# Email backend\nEMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'\n\n# Celery always eager\nCELERY_TASK_ALWAYS_EAGER = True\nCELERY_TASK_EAGER_PROPAGATES = True\n```",
      "zh-Hans": "```python\n# config/settings/test.py\nfrom .base import *\n\nDEBUG = True\nDATABASES = {\n    'default': {\n        'ENGINE': 'django.db.backends.sqlite3',\n        'NAME': ':memory:',\n    }\n}\n\n# Disable migrations for speed\nclass DisableMigrations:\n    def __contains__(self, item):\n        return True\n\n    def __getitem__(self, item):\n        return None\n\nMIGRATION_MODULES = DisableMigrations()\n\n# Faster password hashing\nPASSWORD_HASHERS = [\n    'django.contrib.auth.hashers.MD5PasswordHasher',\n]\n\n# Email backend\nEMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'\n\n# Celery always eager\nCELERY_TASK_ALWAYS_EAGER = True\nCELERY_TASK_EAGER_PROPAGATES = True\n```"
    },
    {
      "en-US": "### conftest.py",
      "zh-Hans": "### conftest.py"
    },
    {
      "en-US": "```python\n# tests/conftest.py\nimport pytest\nfrom django.utils import timezone\nfrom django.contrib.auth import get_user_model\n\nUser = get_user_model()\n\n@pytest.fixture(autouse=True)\ndef timezone_settings(settings):\n    \"\"\"Ensure consistent timezone.\"\"\"\n    settings.TIME_ZONE = 'UTC'\n\n@pytest.fixture\ndef user(db):\n    \"\"\"Create a test user.\"\"\"\n    return User.objects.create_user(\n        email='test@example.com',\n        password='testpass123',\n        username='testuser'\n    )\n\n@pytest.fixture\ndef admin_user(db):\n    \"\"\"Create an admin user.\"\"\"\n    return User.objects.create_superuser(\n        email='admin@example.com',\n        password='adminpass123',\n        username='admin'\n    )\n\n@pytest.fixture\ndef authenticated_client(client, user):\n    \"\"\"Return authenticated client.\"\"\"\n    client.force_login(user)\n    return client\n\n@pytest.fixture\ndef api_client():\n    \"\"\"Return DRF API client.\"\"\"\n    from rest_framework.test import APIClient\n    return APIClient()\n\n@pytest.fixture\ndef authenticated_api_client(api_client, user):\n    \"\"\"Return authenticated API client.\"\"\"\n    api_client.force_authenticate(user=user)\n    return api_client\n```",
      "zh-Hans": "```python\n# tests/conftest.py\nimport pytest\nfrom django.utils import timezone\nfrom django.contrib.auth import get_user_model\n\nUser = get_user_model()\n\n@pytest.fixture(autouse=True)\ndef timezone_settings(settings):\n    \"\"\"Ensure consistent timezone.\"\"\"\n    settings.TIME_ZONE = 'UTC'\n\n@pytest.fixture\ndef user(db):\n    \"\"\"Create a test user.\"\"\"\n    return User.objects.create_user(\n        email='test@example.com',\n        password='testpass123',\n        username='testuser'\n    )\n\n@pytest.fixture\ndef admin_user(db):\n    \"\"\"Create an admin user.\"\"\"\n    return User.objects.create_superuser(\n        email='admin@example.com',\n        password='adminpass123',\n        username='admin'\n    )\n\n@pytest.fixture\ndef authenticated_client(client, user):\n    \"\"\"Return authenticated client.\"\"\"\n    client.force_login(user)\n    return client\n\n@pytest.fixture\ndef api_client():\n    \"\"\"Return DRF API client.\"\"\"\n    from rest_framework.test import APIClient\n    return APIClient()\n\n@pytest.fixture\ndef authenticated_api_client(api_client, user):\n    \"\"\"Return authenticated API client.\"\"\"\n    api_client.force_authenticate(user=user)\n    return api_client\n```"
    },
    {
      "en-US": "## Factory Boy",
      "zh-Hans": "## Factory Boy"
    },
    {
      "en-US": "### Factory Setup",
      "zh-Hans": "### 工厂设置"
    },
    {
      "en-US": "```python\n# tests/factories.py\nimport factory\nfrom factory import fuzzy\nfrom datetime import datetime, timedelta\nfrom django.contrib.auth import get_user_model\nfrom apps.products.models import Product, Category\n\nUser = get_user_model()\n\nclass UserFactory(factory.django.DjangoModelFactory):\n    \"\"\"Factory for User model.\"\"\"\n\n    class Meta:\n        model = User\n\n    email = factory.Sequence(lambda n: f\"user{n}@example.com\")\n    username = factory.Sequence(lambda n: f\"user{n}\")\n    password = factory.PostGenerationMethodCall('set_password', 'testpass123')\n    first_name = factory.Faker('first_name')\n    last_name = factory.Faker('last_name')\n    is_active = True\n\nclass CategoryFactory(factory.django.DjangoModelFactory):\n    \"\"\"Factory for Category model.\"\"\"\n\n    class Meta:\n        model = Category\n\n    name = factory.Faker('word')\n    slug = factory.LazyAttribute(lambda obj: obj.name.lower())\n    description = factory.Faker('text')\n\nclass ProductFactory(factory.django.DjangoModelFactory):\n    \"\"\"Factory for Product model.\"\"\"\n\n    class Meta:\n        model = Product\n\n    name = factory.Faker('sentence', nb_words=3)\n    slug = factory.LazyAttribute(lambda obj: obj.name.lower().replace(' ', '-'))\n    description = factory.Faker('text')\n    price = fuzzy.FuzzyDecimal(10.00, 1000.00, 2)\n    stock = fuzzy.FuzzyInteger(0, 100)\n    is_active = True\n    category = factory.SubFactory(CategoryFactory)\n    created_by = factory.SubFactory(UserFactory)\n\n    @factory.post_generation\n    def tags(self, create, extracted, **kwargs):\n        \"\"\"Add tags to product.\"\"\"\n        if not create:\n            return\n        if extracted:\n            for tag in extracted:\n                self.tags.add(tag)\n```",
      "zh-Hans": "```python\n# tests/factories.py\nimport factory\nfrom factory import fuzzy\nfrom datetime import datetime, timedelta\nfrom django.contrib.auth import get_user_model\nfrom apps.products.models import Product, Category\n\nUser = get_user_model()\n\nclass UserFactory(factory.django.DjangoModelFactory):\n    \"\"\"Factory for User model.\"\"\"\n\n    class Meta:\n        model = User\n\n    email = factory.Sequence(lambda n: f\"user{n}@example.com\")\n    username = factory.Sequence(lambda n: f\"user{n}\")\n    password = factory.PostGenerationMethodCall('set_password', 'testpass123')\n    first_name = factory.Faker('first_name')\n    last_name = factory.Faker('last_name')\n    is_active = True\n\nclass CategoryFactory(factory.django.DjangoModelFactory):\n    \"\"\"Factory for Category model.\"\"\"\n\n    class Meta:\n        model = Category\n\n    name = factory.Faker('word')\n    slug = factory.LazyAttribute(lambda obj: obj.name.lower())\n    description = factory.Faker('text')\n\nclass ProductFactory(factory.django.DjangoModelFactory):\n    \"\"\"Factory for Product model.\"\"\"\n\n    class Meta:\n        model = Product\n\n    name = factory.Faker('sentence', nb_words=3)\n    slug = factory.LazyAttribute(lambda obj: obj.name.lower().replace(' ', '-'))\n    description = factory.Faker('text')\n    price = fuzzy.FuzzyDecimal(10.00, 1000.00, 2)\n    stock = fuzzy.FuzzyInteger(0, 100)\n    is_active = True\n    category = factory.SubFactory(CategoryFactory)\n    created_by = factory.SubFactory(UserFactory)\n\n    @factory.post_generation\n    def tags(self, create, extracted, **kwargs):\n        \"\"\"Add tags to product.\"\"\"\n        if not create:\n            return\n        if extracted:\n            for tag in extracted:\n                self.tags.add(tag)\n```"
    },
    {
      "en-US": "### Using Factories",
      "zh-Hans": "### 使用工厂"
    },
    {
      "en-US": "```python\n# tests/test_models.py\nimport pytest\nfrom tests.factories import ProductFactory, UserFactory\n\ndef test_product_creation():\n    \"\"\"Test product creation using factory.\"\"\"\n    product = ProductFactory(price=100.00, stock=50)\n    assert product.price == 100.00\n    assert product.stock == 50\n    assert product.is_active is True\n\ndef test_product_with_tags():\n    \"\"\"Test product with tags.\"\"\"\n    tags = [TagFactory(name='electronics'), TagFactory(name='new')]\n    product = ProductFactory(tags=tags)\n    assert product.tags.count() == 2\n\ndef test_multiple_products():\n    \"\"\"Test creating multiple products.\"\"\"\n    products = ProductFactory.create_batch(10)\n    assert len(products) == 10\n```",
      "zh-Hans": "```python\n# tests/test_models.py\nimport pytest\nfrom tests.factories import ProductFactory, UserFactory\n\ndef test_product_creation():\n    \"\"\"Test product creation using factory.\"\"\"\n    product = ProductFactory(price=100.00, stock=50)\n    assert product.price == 100.00\n    assert product.stock == 50\n    assert product.is_active is True\n\ndef test_product_with_tags():\n    \"\"\"Test product with tags.\"\"\"\n    tags = [TagFactory(name='electronics'), TagFactory(name='new')]\n    product = ProductFactory(tags=tags)\n    assert product.tags.count() == 2\n\ndef test_multiple_products():\n    \"\"\"Test creating multiple products.\"\"\"\n    products = ProductFactory.create_batch(10)\n    assert len(products) == 10\n```"
    },
    {
      "en-US": "## Model Testing",
      "zh-Hans": "## 模型测试"
    },
    {
      "en-US": "### Model Tests",
      "zh-Hans": "### 模型测试"
    },
    {
      "en-US": "```python\n# tests/test_models.py\nimport pytest\nfrom django.core.exceptions import ValidationError\nfrom tests.factories import UserFactory, ProductFactory\n\nclass TestUserModel:\n    \"\"\"Test User model.\"\"\"\n\n    def test_create_user(self, db):\n        \"\"\"Test creating a regular user.\"\"\"\n        user = UserFactory(email='test@example.com')\n        assert user.email == 'test@example.com'\n        assert user.check_password('testpass123')\n        assert not user.is_staff\n        assert not user.is_superuser\n\n    def test_create_superuser(self, db):\n        \"\"\"Test creating a superuser.\"\"\"\n        user = UserFactory(\n            email='admin@example.com',\n            is_staff=True,\n            is_superuser=True\n        )\n        assert user.is_staff\n        assert user.is_superuser\n\n    def test_user_str(self, db):\n        \"\"\"Test user string representation.\"\"\"\n        user = UserFactory(email='test@example.com')\n        assert str(user) == 'test@example.com'\n\nclass TestProductModel:\n    \"\"\"Test Product model.\"\"\"\n\n    def test_product_creation(self, db):\n        \"\"\"Test creating a product.\"\"\"\n        product = ProductFactory()\n        assert product.id is not None\n        assert product.is_active is True\n        assert product.created_at is not None\n\n    def test_product_slug_generation(self, db):\n        \"\"\"Test automatic slug generation.\"\"\"\n        product = ProductFactory(name='Test Product')\n        assert product.slug == 'test-product'\n\n    def test_product_price_validation(self, db):\n        \"\"\"Test price cannot be negative.\"\"\"\n        product = ProductFactory(price=-10)\n        with pytest.raises(ValidationError):\n            product.full_clean()\n\n    def test_product_manager_active(self, db):\n        \"\"\"Test active manager method.\"\"\"\n        ProductFactory.create_batch(5, is_active=True)\n        ProductFactory.create_batch(3, is_active=False)\n\n        active_count = Product.objects.active().count()\n        assert active_count == 5\n\n    def test_product_stock_management(self, db):\n        \"\"\"Test stock management.\"\"\"\n        product = ProductFactory(stock=10)\n        product.reduce_stock(5)\n        product.refresh_from_db()\n        assert product.stock == 5\n\n        with pytest.raises(ValueError):\n            product.reduce_stock(10)  # Not enough stock\n```",
      "zh-Hans": "```python\n# tests/test_models.py\nimport pytest\nfrom django.core.exceptions import ValidationError\nfrom tests.factories import UserFactory, ProductFactory\n\nclass TestUserModel:\n    \"\"\"Test User model.\"\"\"\n\n    def test_create_user(self, db):\n        \"\"\"Test creating a regular user.\"\"\"\n        user = UserFactory(email='test@example.com')\n        assert user.email == 'test@example.com'\n        assert user.check_password('testpass123')\n        assert not user.is_staff\n        assert not user.is_superuser\n\n    def test_create_superuser(self, db):\n        \"\"\"Test creating a superuser.\"\"\"\n        user = UserFactory(\n            email='admin@example.com',\n            is_staff=True,\n            is_superuser=True\n        )\n        assert user.is_staff\n        assert user.is_superuser\n\n    def test_user_str(self, db):\n        \"\"\"Test user string representation.\"\"\"\n        user = UserFactory(email='test@example.com')\n        assert str(user) == 'test@example.com'\n\nclass TestProductModel:\n    \"\"\"Test Product model.\"\"\"\n\n    def test_product_creation(self, db):\n        \"\"\"Test creating a product.\"\"\"\n        product = ProductFactory()\n        assert product.id is not None\n        assert product.is_active is True\n        assert product.created_at is not None\n\n    def test_product_slug_generation(self, db):\n        \"\"\"Test automatic slug generation.\"\"\"\n        product = ProductFactory(name='Test Product')\n        assert product.slug == 'test-product'\n\n    def test_product_price_validation(self, db):\n        \"\"\"Test price cannot be negative.\"\"\"\n        product = ProductFactory(price=-10)\n        with pytest.raises(ValidationError):\n            product.full_clean()\n\n    def test_product_manager_active(self, db):\n        \"\"\"Test active manager method.\"\"\"\n        ProductFactory.create_batch(5, is_active=True)\n        ProductFactory.create_batch(3, is_active=False)\n\n        active_count = Product.objects.active().count()\n        assert active_count == 5\n\n    def test_product_stock_management(self, db):\n        \"\"\"Test stock management.\"\"\"\n        product = ProductFactory(stock=10)\n        product.reduce_stock(5)\n        product.refresh_from_db()\n        assert product.stock == 5\n\n        with pytest.raises(ValueError):\n            product.reduce_stock(10)  # Not enough stock\n```"
    },
    {
      "en-US": "## View Testing",
      "zh-Hans": "## 视图测试"
    },
    {
      "en-US": "### Django View Testing",
      "zh-Hans": "### Django 视图测试"
    },
    {
      "en-US": "```python\n# tests/test_views.py\nimport pytest\nfrom django.urls import reverse\nfrom tests.factories import ProductFactory, UserFactory\n\nclass TestProductViews:\n    \"\"\"Test product views.\"\"\"\n\n    def test_product_list(self, client, db):\n        \"\"\"Test product list view.\"\"\"\n        ProductFactory.create_batch(10)\n\n        response = client.get(reverse('products:list'))\n\n        assert response.status_code == 200\n        assert len(response.context['products']) == 10\n\n    def test_product_detail(self, client, db):\n        \"\"\"Test product detail view.\"\"\"\n        product = ProductFactory()\n\n        response = client.get(reverse('products:detail', kwargs={'slug': product.slug}))\n\n        assert response.status_code == 200\n        assert response.context['product'] == product\n\n    def test_product_create_requires_login(self, client, db):\n        \"\"\"Test product creation requires authentication.\"\"\"\n        response = client.get(reverse('products:create'))\n\n        assert response.status_code == 302\n        assert response.url.startswith('/accounts/login/')\n\n    def test_product_create_authenticated(self, authenticated_client, db):\n        \"\"\"Test product creation as authenticated user.\"\"\"\n        response = authenticated_client.get(reverse('products:create'))\n\n        assert response.status_code == 200\n\n    def test_product_create_post(self, authenticated_client, db, category):\n        \"\"\"Test creating a product via POST.\"\"\"\n        data = {\n            'name': 'Test Product',\n            'description': 'A test product',\n            'price': '99.99',\n            'stock': 10,\n            'category': category.id,\n        }\n\n        response = authenticated_client.post(reverse('products:create'), data)\n\n        assert response.status_code == 302\n        assert Product.objects.filter(name='Test Product').exists()\n```",
      "zh-Hans": "```python\n# tests/test_views.py\nimport pytest\nfrom django.urls import reverse\nfrom tests.factories import ProductFactory, UserFactory\n\nclass TestProductViews:\n    \"\"\"Test product views.\"\"\"\n\n    def test_product_list(self, client, db):\n        \"\"\"Test product list view.\"\"\"\n        ProductFactory.create_batch(10)\n\n        response = client.get(reverse('products:list'))\n\n        assert response.status_code == 200\n        assert len(response.context['products']) == 10\n\n    def test_product_detail(self, client, db):\n        \"\"\"Test product detail view.\"\"\"\n        product = ProductFactory()\n\n        response = client.get(reverse('products:detail', kwargs={'slug': product.slug}))\n\n        assert response.status_code == 200\n        assert response.context['product'] == product\n\n    def test_product_create_requires_login(self, client, db):\n        \"\"\"Test product creation requires authentication.\"\"\"\n        response = client.get(reverse('products:create'))\n\n        assert response.status_code == 302\n        assert response.url.startswith('/accounts/login/')\n\n    def test_product_create_authenticated(self, authenticated_client, db):\n        \"\"\"Test product creation as authenticated user.\"\"\"\n        response = authenticated_client.get(reverse('products:create'))\n\n        assert response.status_code == 200\n\n    def test_product_create_post(self, authenticated_client, db, category):\n        \"\"\"Test creating a product via POST.\"\"\"\n        data = {\n            'name': 'Test Product',\n            'description': 'A test product',\n            'price': '99.99',\n            'stock': 10,\n            'category': category.id,\n        }\n\n        response = authenticated_client.post(reverse('products:create'), data)\n\n        assert response.status_code == 302\n        assert Product.objects.filter(name='Test Product').exists()\n```"
    },
    {
      "en-US": "## DRF API Testing",
      "zh-Hans": "## DRF API 测试"
    },
    {
      "en-US": "### Serializer Testing",
      "zh-Hans": "### 序列化器测试"
    },
    {
      "en-US": "```python\n# tests/test_serializers.py\nimport pytest\nfrom rest_framework.exceptions import ValidationError\nfrom apps.products.serializers import ProductSerializer\nfrom tests.factories import ProductFactory\n\nclass TestProductSerializer:\n    \"\"\"Test ProductSerializer.\"\"\"\n\n    def test_serialize_product(self, db):\n        \"\"\"Test serializing a product.\"\"\"\n        product = ProductFactory()\n        serializer = ProductSerializer(product)\n\n        data = serializer.data\n\n        assert data['id'] == product.id\n        assert data['name'] == product.name\n        assert data['price'] == str(product.price)\n\n    def test_deserialize_product(self, db):\n        \"\"\"Test deserializing product data.\"\"\"\n        data = {\n            'name': 'Test Product',\n            'description': 'Test description',\n            'price': '99.99',\n            'stock': 10,\n            'category': 1,\n        }\n\n        serializer = ProductSerializer(data=data)\n\n        assert serializer.is_valid()\n        product = serializer.save()\n\n        assert product.name == 'Test Product'\n        assert float(product.price) == 99.99\n\n    def test_price_validation(self, db):\n        \"\"\"Test price validation.\"\"\"\n        data = {\n            'name': 'Test Product',\n            'price': '-10.00',\n            'stock': 10,\n        }\n\n        serializer = ProductSerializer(data=data)\n\n        assert not serializer.is_valid()\n        assert 'price' in serializer.errors\n\n    def test_stock_validation(self, db):\n        \"\"\"Test stock cannot be negative.\"\"\"\n        data = {\n            'name': 'Test Product',\n            'price': '99.99',\n            'stock': -5,\n        }\n\n        serializer = ProductSerializer(data=data)\n\n        assert not serializer.is_valid()\n        assert 'stock' in serializer.errors\n```",
      "zh-Hans": "```python\n# tests/test_serializers.py\nimport pytest\nfrom rest_framework.exceptions import ValidationError\nfrom apps.products.serializers import ProductSerializer\nfrom tests.factories import ProductFactory\n\nclass TestProductSerializer:\n    \"\"\"Test ProductSerializer.\"\"\"\n\n    def test_serialize_product(self, db):\n        \"\"\"Test serializing a product.\"\"\"\n        product = ProductFactory()\n        serializer = ProductSerializer(product)\n\n        data = serializer.data\n\n        assert data['id'] == product.id\n        assert data['name'] == product.name\n        assert data['price'] == str(product.price)\n\n    def test_deserialize_product(self, db):\n        \"\"\"Test deserializing product data.\"\"\"\n        data = {\n            'name': 'Test Product',\n            'description': 'Test description',\n            'price': '99.99',\n            'stock': 10,\n            'category': 1,\n        }\n\n        serializer = ProductSerializer(data=data)\n\n        assert serializer.is_valid()\n        product = serializer.save()\n\n        assert product.name == 'Test Product'\n        assert float(product.price) == 99.99\n\n    def test_price_validation(self, db):\n        \"\"\"Test price validation.\"\"\"\n        data = {\n            'name': 'Test Product',\n            'price': '-10.00',\n            'stock': 10,\n        }\n\n        serializer = ProductSerializer(data=data)\n\n        assert not serializer.is_valid()\n        assert 'price' in serializer.errors\n\n    def test_stock_validation(self, db):\n        \"\"\"Test stock cannot be negative.\"\"\"\n        data = {\n            'name': 'Test Product',\n            'price': '99.99',\n            'stock': -5,\n        }\n\n        serializer = ProductSerializer(data=data)\n\n        assert not serializer.is_valid()\n        assert 'stock' in serializer.errors\n```"
    },
    {
      "en-US": "### API ViewSet Testing",
      "zh-Hans": "### API ViewSet 测试"
    },
    {
      "en-US": "```python\n# tests/test_api.py\nimport pytest\nfrom rest_framework.test import APIClient\nfrom rest_framework import status\nfrom django.urls import reverse\nfrom tests.factories import ProductFactory, UserFactory\n\nclass TestProductAPI:\n    \"\"\"Test Product API endpoints.\"\"\"\n\n    @pytest.fixture\n    def api_client(self):\n        \"\"\"Return API client.\"\"\"\n        return APIClient()\n\n    def test_list_products(self, api_client, db):\n        \"\"\"Test listing products.\"\"\"\n        ProductFactory.create_batch(10)\n\n        url = reverse('api:product-list')\n        response = api_client.get(url)\n\n        assert response.status_code == status.HTTP_200_OK\n        assert response.data['count'] == 10\n\n    def test_retrieve_product(self, api_client, db):\n        \"\"\"Test retrieving a product.\"\"\"\n        product = ProductFactory()\n\n        url = reverse('api:product-detail', kwargs={'pk': product.id})\n        response = api_client.get(url)\n\n        assert response.status_code == status.HTTP_200_OK\n        assert response.data['id'] == product.id\n\n    def test_create_product_unauthorized(self, api_client, db):\n        \"\"\"Test creating product without authentication.\"\"\"\n        url = reverse('api:product-list')\n        data = {'name': 'Test Product', 'price': '99.99'}\n\n        response = api_client.post(url, data)\n\n        assert response.status_code == status.HTTP_401_UNAUTHORIZED\n\n    def test_create_product_authorized(self, authenticated_api_client, db):\n        \"\"\"Test creating product as authenticated user.\"\"\"\n        url = reverse('api:product-list')\n        data = {\n            'name': 'Test Product',\n            'description': 'Test',\n            'price': '99.99',\n            'stock': 10,\n        }\n\n        response = authenticated_api_client.post(url, data)\n\n        assert response.status_code == status.HTTP_201_CREATED\n        assert response.data['name'] == 'Test Product'\n\n    def test_update_product(self, authenticated_api_client, db):\n        \"\"\"Test updating a product.\"\"\"\n        product = ProductFactory(created_by=authenticated_api_client.user)\n\n        url = reverse('api:product-detail', kwargs={'pk': product.id})\n        data = {'name': 'Updated Product'}\n\n        response = authenticated_api_client.patch(url, data)\n\n        assert response.status_code == status.HTTP_200_OK\n        assert response.data['name'] == 'Updated Product'\n\n    def test_delete_product(self, authenticated_api_client, db):\n        \"\"\"Test deleting a product.\"\"\"\n        product = ProductFactory(created_by=authenticated_api_client.user)\n\n        url = reverse('api:product-detail', kwargs={'pk': product.id})\n        response = authenticated_api_client.delete(url)\n\n        assert response.status_code == status.HTTP_204_NO_CONTENT\n\n    def test_filter_products_by_price(self, api_client, db):\n        \"\"\"Test filtering products by price.\"\"\"\n        ProductFactory(price=50)\n        ProductFactory(price=150)\n\n        url = reverse('api:product-list')\n        response = api_client.get(url, {'price_min': 100})\n\n        assert response.status_code == status.HTTP_200_OK\n        assert response.data['count'] == 1\n\n    def test_search_products(self, api_client, db):\n        \"\"\"Test searching products.\"\"\"\n        ProductFactory(name='Apple iPhone')\n        ProductFactory(name='Samsung Galaxy')\n\n        url = reverse('api:product-list')\n        response = api_client.get(url, {'search': 'Apple'})\n\n        assert response.status_code == status.HTTP_200_OK\n        assert response.data['count'] == 1\n```",
      "zh-Hans": "```python\n# tests/test_api.py\nimport pytest\nfrom rest_framework.test import APIClient\nfrom rest_framework import status\nfrom django.urls import reverse\nfrom tests.factories import ProductFactory, UserFactory\n\nclass TestProductAPI:\n    \"\"\"Test Product API endpoints.\"\"\"\n\n    @pytest.fixture\n    def api_client(self):\n        \"\"\"Return API client.\"\"\"\n        return APIClient()\n\n    def test_list_products(self, api_client, db):\n        \"\"\"Test listing products.\"\"\"\n        ProductFactory.create_batch(10)\n\n        url = reverse('api:product-list')\n        response = api_client.get(url)\n\n        assert response.status_code == status.HTTP_200_OK\n        assert response.data['count'] == 10\n\n    def test_retrieve_product(self, api_client, db):\n        \"\"\"Test retrieving a product.\"\"\"\n        product = ProductFactory()\n\n        url = reverse('api:product-detail', kwargs={'pk': product.id})\n        response = api_client.get(url)\n\n        assert response.status_code == status.HTTP_200_OK\n        assert response.data['id'] == product.id\n\n    def test_create_product_unauthorized(self, api_client, db):\n        \"\"\"Test creating product without authentication.\"\"\"\n        url = reverse('api:product-list')\n        data = {'name': 'Test Product', 'price': '99.99'}\n\n        response = api_client.post(url, data)\n\n        assert response.status_code == status.HTTP_401_UNAUTHORIZED\n\n    def test_create_product_authorized(self, authenticated_api_client, db):\n        \"\"\"Test creating product as authenticated user.\"\"\"\n        url = reverse('api:product-list')\n        data = {\n            'name': 'Test Product',\n            'description': 'Test',\n            'price': '99.99',\n            'stock': 10,\n        }\n\n        response = authenticated_api_client.post(url, data)\n\n        assert response.status_code == status.HTTP_201_CREATED\n        assert response.data['name'] == 'Test Product'\n\n    def test_update_product(self, authenticated_api_client, db):\n        \"\"\"Test updating a product.\"\"\"\n        product = ProductFactory(created_by=authenticated_api_client.user)\n\n        url = reverse('api:product-detail', kwargs={'pk': product.id})\n        data = {'name': 'Updated Product'}\n\n        response = authenticated_api_client.patch(url, data)\n\n        assert response.status_code == status.HTTP_200_OK\n        assert response.data['name'] == 'Updated Product'\n\n    def test_delete_product(self, authenticated_api_client, db):\n        \"\"\"Test deleting a product.\"\"\"\n        product = ProductFactory(created_by=authenticated_api_client.user)\n\n        url = reverse('api:product-detail', kwargs={'pk': product.id})\n        response = authenticated_api_client.delete(url)\n\n        assert response.status_code == status.HTTP_204_NO_CONTENT\n\n    def test_filter_products_by_price(self, api_client, db):\n        \"\"\"Test filtering products by price.\"\"\"\n        ProductFactory(price=50)\n        ProductFactory(price=150)\n\n        url = reverse('api:product-list')\n        response = api_client.get(url, {'price_min': 100})\n\n        assert response.status_code == status.HTTP_200_OK\n        assert response.data['count'] == 1\n\n    def test_search_products(self, api_client, db):\n        \"\"\"Test searching products.\"\"\"\n        ProductFactory(name='Apple iPhone')\n        ProductFactory(name='Samsung Galaxy')\n\n        url = reverse('api:product-list')\n        response = api_client.get(url, {'search': 'Apple'})\n\n        assert response.status_code == status.HTTP_200_OK\n        assert response.data['count'] == 1\n```"
    },
    {
      "en-US": "## Mocking and Patching",
      "zh-Hans": "## 模拟与打补丁"
    },
    {
      "en-US": "### Mocking External Services",
      "zh-Hans": "### 模拟外部服务"
    },
    {
      "en-US": "```python\n# tests/test_views.py\nfrom unittest.mock import patch, Mock\nimport pytest\n\nclass TestPaymentView:\n    \"\"\"Test payment view with mocked payment gateway.\"\"\"\n\n    @patch('apps.payments.services.stripe')\n    def test_successful_payment(self, mock_stripe, client, user, product):\n        \"\"\"Test successful payment with mocked Stripe.\"\"\"\n        # Configure mock\n        mock_stripe.Charge.create.return_value = {\n            'id': 'ch_123',\n            'status': 'succeeded',\n            'amount': 9999,\n        }\n\n        client.force_login(user)\n        response = client.post(reverse('payments:process'), {\n            'product_id': product.id,\n            'token': 'tok_visa',\n        })\n\n        assert response.status_code == 302\n        mock_stripe.Charge.create.assert_called_once()\n\n    @patch('apps.payments.services.stripe')\n    def test_failed_payment(self, mock_stripe, client, user, product):\n        \"\"\"Test failed payment.\"\"\"\n        mock_stripe.Charge.create.side_effect = Exception('Card declined')\n\n        client.force_login(user)\n        response = client.post(reverse('payments:process'), {\n            'product_id': product.id,\n            'token': 'tok_visa',\n        })\n\n        assert response.status_code == 302\n        assert 'error' in response.url\n```",
      "zh-Hans": "```python\n# tests/test_views.py\nfrom unittest.mock import patch, Mock\nimport pytest\n\nclass TestPaymentView:\n    \"\"\"Test payment view with mocked payment gateway.\"\"\"\n\n    @patch('apps.payments.services.stripe')\n    def test_successful_payment(self, mock_stripe, client, user, product):\n        \"\"\"Test successful payment with mocked Stripe.\"\"\"\n        # Configure mock\n        mock_stripe.Charge.create.return_value = {\n            'id': 'ch_123',\n            'status': 'succeeded',\n            'amount': 9999,\n        }\n\n        client.force_login(user)\n        response = client.post(reverse('payments:process'), {\n            'product_id': product.id,\n            'token': 'tok_visa',\n        })\n\n        assert response.status_code == 302\n        mock_stripe.Charge.create.assert_called_once()\n\n    @patch('apps.payments.services.stripe')\n    def test_failed_payment(self, mock_stripe, client, user, product):\n        \"\"\"Test failed payment.\"\"\"\n        mock_stripe.Charge.create.side_effect = Exception('Card declined')\n\n        client.force_login(user)\n        response = client.post(reverse('payments:process'), {\n            'product_id': product.id,\n            'token': 'tok_visa',\n        })\n\n        assert response.status_code == 302\n        assert 'error' in response.url\n```"
    },
    {
      "en-US": "### Mocking Email Sending",
      "zh-Hans": "### 模拟邮件发送"
    },
    {
      "en-US": "```python\n# tests/test_email.py\nfrom django.core import mail\nfrom django.test import override_settings\n\n@override_settings(EMAIL_BACKEND='django.core.mail.backends.locmem.EmailBackend')\ndef test_order_confirmation_email(db, order):\n    \"\"\"Test order confirmation email.\"\"\"\n    order.send_confirmation_email()\n\n    assert len(mail.outbox) == 1\n    assert order.user.email in mail.outbox[0].to\n    assert 'Order Confirmation' in mail.outbox[0].subject\n```",
      "zh-Hans": "```python\n# tests/test_email.py\nfrom django.core import mail\nfrom django.test import override_settings\n\n@override_settings(EMAIL_BACKEND='django.core.mail.backends.locmem.EmailBackend')\ndef test_order_confirmation_email(db, order):\n    \"\"\"Test order confirmation email.\"\"\"\n    order.send_confirmation_email()\n\n    assert len(mail.outbox) == 1\n    assert order.user.email in mail.outbox[0].to\n    assert 'Order Confirmation' in mail.outbox[0].subject\n```"
    },
    {
      "en-US": "## Integration Testing",
      "zh-Hans": "## 集成测试"
    },
    {
      "en-US": "### Full Flow Testing",
      "zh-Hans": "### 完整流程测试"
    },
    {
      "en-US": "```python\n# tests/test_integration.py\nimport pytest\nfrom django.urls import reverse\nfrom tests.factories import UserFactory, ProductFactory\n\nclass TestCheckoutFlow:\n    \"\"\"Test complete checkout flow.\"\"\"\n\n    def test_guest_to_purchase_flow(self, client, db):\n        \"\"\"Test complete flow from guest to purchase.\"\"\"\n        # Step 1: Register\n        response = client.post(reverse('users:register'), {\n            'email': 'test@example.com',\n            'password': 'testpass123',\n            'password_confirm': 'testpass123',\n        })\n        assert response.status_code == 302\n\n        # Step 2: Login\n        response = client.post(reverse('users:login'), {\n            'email': 'test@example.com',\n            'password': 'testpass123',\n        })\n        assert response.status_code == 302\n\n        # Step 3: Browse products\n        product = ProductFactory(price=100)\n        response = client.get(reverse('products:detail', kwargs={'slug': product.slug}))\n        assert response.status_code == 200\n\n        # Step 4: Add to cart\n        response = client.post(reverse('cart:add'), {\n            'product_id': product.id,\n            'quantity': 1,\n        })\n        assert response.status_code == 302\n\n        # Step 5: Checkout\n        response = client.get(reverse('checkout:review'))\n        assert response.status_code == 200\n        assert product.name in response.content.decode()\n\n        # Step 6: Complete purchase\n        with patch('apps.checkout.services.process_payment') as mock_payment:\n            mock_payment.return_value = True\n            response = client.post(reverse('checkout:complete'))\n\n        assert response.status_code == 302\n        assert Order.objects.filter(user__email='test@example.com').exists()\n```",
      "zh-Hans": "```python\n# tests/test_integration.py\nimport pytest\nfrom django.urls import reverse\nfrom tests.factories import UserFactory, ProductFactory\n\nclass TestCheckoutFlow:\n    \"\"\"Test complete checkout flow.\"\"\"\n\n    def test_guest_to_purchase_flow(self, client, db):\n        \"\"\"Test complete flow from guest to purchase.\"\"\"\n        # Step 1: Register\n        response = client.post(reverse('users:register'), {\n            'email': 'test@example.com',\n            'password': 'testpass123',\n            'password_confirm': 'testpass123',\n        })\n        assert response.status_code == 302\n\n        # Step 2: Login\n        response = client.post(reverse('users:login'), {\n            'email': 'test@example.com',\n            'password': 'testpass123',\n        })\n        assert response.status_code == 302\n\n        # Step 3: Browse products\n        product = ProductFactory(price=100)\n        response = client.get(reverse('products:detail', kwargs={'slug': product.slug}))\n        assert response.status_code == 200\n\n        # Step 4: Add to cart\n        response = client.post(reverse('cart:add'), {\n            'product_id': product.id,\n            'quantity': 1,\n        })\n        assert response.status_code == 302\n\n        # Step 5: Checkout\n        response = client.get(reverse('checkout:review'))\n        assert response.status_code == 200\n        assert product.name in response.content.decode()\n\n        # Step 6: Complete purchase\n        with patch('apps.checkout.services.process_payment') as mock_payment:\n            mock_payment.return_value = True\n            response = client.post(reverse('checkout:complete'))\n\n        assert response.status_code == 302\n        assert Order.objects.filter(user__email='test@example.com').exists()\n```"
    },
    {
      "en-US": "## Testing Best Practices",
      "zh-Hans": "## 测试最佳实践"
    },
    {
      "en-US": "### DO",
      "zh-Hans": "### 应该做"
    },
    {
      "en-US": "- **Use factories**: Instead of manual object creation\n- **One assertion per test**: Keep tests focused\n- **Descriptive test names**: `test_user_cannot_delete_others_post`\n- **Test edge cases**: Empty inputs, None values, boundary conditions\n- **Mock external services**: Don't depend on external APIs\n- **Use fixtures**: Eliminate duplication\n- **Test permissions**: Ensure authorization works\n- **Keep tests fast**: Use `--reuse-db` and `--nomigrations`",
      "zh-Hans": "* **使用工厂**：而不是手动创建对象\n* **每个测试一个断言**：保持测试聚焦\n* **描述性测试名称**：`test_user_cannot_delete_others_post`\n* **测试边界情况**：空输入、None 值、边界条件\n* **模拟外部服务**：不要依赖外部 API\n* **使用夹具**：消除重复\n* **测试权限**：确保授权有效\n* **保持测试快速**：使用 `--reuse-db` 和 `--nomigrations`"
    },
    {
      "en-US": "### DON'T",
      "zh-Hans": "### 不应该做"
    },
    {
      "en-US": "- **Don't test Django internals**: Trust Django to work\n- **Don't test third-party code**: Trust libraries to work\n- **Don't ignore failing tests**: All tests must pass\n- **Don't make tests dependent**: Tests should run in any order\n- **Don't over-mock**: Mock only external dependencies\n- **Don't test private methods**: Test public interface\n- **Don't use production database**: Always use test database",
      "zh-Hans": "* **不要测试 Django 内部**：相信 Django 能正常工作\n* **不要测试第三方代码**：相信库能正常工作\n* **不要忽略失败的测试**：所有测试必须通过\n* **不要让测试产生依赖**：测试应该能以任何顺序运行\n* **不要过度模拟**：只模拟外部依赖\n* **不要测试私有方法**：测试公共接口\n* **不要使用生产数据库**：始终使用测试数据库"
    },
    {
      "en-US": "## Coverage",
      "zh-Hans": "## 覆盖率"
    },
    {
      "en-US": "### Coverage Configuration",
      "zh-Hans": "### 覆盖率配置"
    },
    {
      "en-US": "```bash\n# Run tests with coverage\npytest --cov=apps --cov-report=html --cov-report=term-missing\n\n# Generate HTML report\nopen htmlcov/index.html\n```",
      "zh-Hans": "```bash\n# Run tests with coverage\npytest --cov=apps --cov-report=html --cov-report=term-missing\n\n# Generate HTML report\nopen htmlcov/index.html\n```"
    },
    {
      "en-US": "### Coverage Goals",
      "zh-Hans": "### 覆盖率目标"
    },
    {
      "en-US": "| Component | Target Coverage |\n|-----------|-----------------|\n| Models | 90%+ |\n| Serializers | 85%+ |\n| Views | 80%+ |\n| Services | 90%+ |\n| Utilities | 80%+ |\n| Overall | 80%+ |",
      "zh-Hans": "| 组件 | 目标覆盖率 |\n|-----------|-----------------|\n| 模型 | 90%+ |\n| 序列化器 | 85%+ |\n| 视图 | 80%+ |\n| 服务 | 90%+ |\n| 工具 | 80%+ |\n| 总体 | 80%+ |"
    },
    {
      "en-US": "## Quick Reference",
      "zh-Hans": "## 快速参考"
    },
    {
      "en-US": "| Pattern | Usage |\n|---------|-------|\n| `@pytest.mark.django_db` | Enable database access |\n| `client` | Django test client |\n| `api_client` | DRF API client |\n| `factory.create_batch(n)` | Create multiple objects |\n| `patch('module.function')` | Mock external dependencies |\n| `override_settings` | Temporarily change settings |\n| `force_authenticate()` | Bypass authentication in tests |\n| `assertRedirects` | Check for redirects |\n| `assertTemplateUsed` | Verify template usage |\n| `mail.outbox` | Check sent emails |",
      "zh-Hans": "| 模式 | 用途 |\n|---------|-------|\n| `@pytest.mark.django_db` | 启用数据库访问 |\n| `client` | Django 测试客户端 |\n| `api_client` | DRF API 客户端 |\n| `factory.create_batch(n)` | 创建多个对象 |\n| `patch('module.function')` | 模拟外部依赖 |\n| `override_settings` | 临时更改设置 |\n| `force_authenticate()` | 在测试中绕过身份验证 |\n| `assertRedirects` | 检查重定向 |\n| `assertTemplateUsed` | 验证模板使用 |\n| `mail.outbox` | 检查已发送的邮件 |"
    },
    {
      "en-US": "Remember: Tests are documentation. Good tests explain how your code should work. Keep them simple, readable, and maintainable.",
      "zh-Hans": "记住：测试即文档。好的测试解释了你的代码应如何工作。保持测试简单、可读和可维护。"
    }
  ]
}